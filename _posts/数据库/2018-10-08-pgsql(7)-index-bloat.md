---
layout: post
title: PGSQL(7)-index-bloat
author: itsxun
date: 2018-10-08 14:23:14 +0800
catalog: true
tags:
    - 数据库
---

## 引入

虽然pgsql默认的B树索引在insert方面性能不错，但是在delete的时候，会导致索引中存在的无效数据，导致索引膨胀。无效数据会占用着更多的内存，磁盘，导致更多的磁盘IO。

## Cause

可能导致索引膨胀的原因有三种：

1. 删除列：列的删除会让索引失效，索引页里面的索引如果全部失效了会回收利用，如果失效的索引越来越多，则索引页里面的无效数据会越来越多，造成索引膨胀。

2. PostgreSQL 9.0之前，Vacuum Full在搬动列的过程中，新位置的索引会先被建立，然后被删除，所以会造成索引膨胀。

3. 长会话。长会话会阻塞vacuum，导致表中无效数据会越来越多，造成索引膨胀。

## 解决办法

1. Dump and restore

最简单粗暴的解决办法，pg_dump工具可以导出整个库，然后重建schema，导入数据。
这个办法几乎能解决所有的DB阻塞问题，但是缺点也很明显，代价相当昂贵。

2. Vacuum

vacuum会再次调整表，确保表的每页尽可能放满列。但是表占用磁盘大小可能不会发生明显收缩，因为仅仅满足表的尾部是连续的无效空间才会被回收。

3. Cluster

Cluster命令会根据index来重新给列排序，它会建立一张新的表，接着老的表会被删除。

4. Reindex

如果索引比较散乱，也可以通过reindex来重建索引。
